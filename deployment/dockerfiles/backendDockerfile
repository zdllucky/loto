FROM node:16-alpine

ARG DATABASE_URL
ARG COOKIE_SECRET
ARG REDIS_HOST

ENV DATABASE_URL=$DATABASE_URL
ENV COOKIE_SECRET=$COOKIE_SECRET
ENV REDIS_HOST=$REDIS_HOST

WORKDIR /app

COPY . .

RUN rm -rf client

RUN DATABASE_URL=$DATABASE_URL COOKIE_SECRET=$COOKIE_SECRET REDIS_HOST=$REDIS_HOST npm install --omit=dev --registry http://localhost:4873

RUN DATABASE_URL=$DATABASE_URL COOKIE_SECRET=$COOKIE_SECRET REDIS_HOST=$REDIS_HOST npm run build

EXPOSE 3000

CMD ["npm", "run", "migrate_start"]
